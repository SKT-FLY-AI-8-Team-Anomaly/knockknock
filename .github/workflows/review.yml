name: Assign Reviewers from CODEOWNERS

on:
  pull_request:
    types: [opened, reopened, ready_for_review]

jobs:
  assign-reviewers:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read # 파일 읽기 권한 필요
    steps:
      - name: Checkout code
        uses: actions/checkout@v4 # CODEOWNERS 파일을 읽으려면 체크아웃이 필수입니다.

      - name: Assign reviewers based on CODEOWNERS
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // 1. PR 정보 가져오기
            const author = context.payload.pull_request.user.login;
            const prNumber = context.payload.pull_request.number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const codeownersPath = '.github/CODEOWNERS';

            console.log(`Checking ${codeownersPath}...`);

            try {
              // 2. CODEOWNERS 파일 읽기
              if (!fs.existsSync(codeownersPath)) {
                console.log("⚠️ CODEOWNERS file not found.");
                return;
              }

              const content = fs.readFileSync(codeownersPath, 'utf8');
              console.log("File content loaded.");

              // 3. 정규식으로 @username 패턴 추출 (팀이나 이메일 제외하고 유저 아이디만 추출)
              // 예: * @user1 @user2 -> user1, user2 추출
              const matches = content.match(/@([a-zA-Z0-9-]+)/g);

              if (!matches) {
                console.log("No users found in CODEOWNERS.");
                return;
              }

              // 4. 중복 제거 및 @ 제거, 작성자(Author) 제외
              const reviewers = [...new Set(matches)]
                .map(user => user.replace('@', '')) // @ 제거
                .filter(user => user !== author);   // 작성자 제외

              console.log(`Target Reviewers: ${reviewers.join(', ')}`);

              // 5. 리뷰어 요청 전송
              if (reviewers.length > 0) {
                await github.rest.pulls.requestReviewers({
                  owner,
                  repo,
                  pull_number: prNumber,
                  reviewers: reviewers
                });
                console.log("✅ Review request sent successfully.");
              } else {
                console.log("⚠️ No eligible reviewers found (excluding author).");
              }

            } catch (error) {
              console.log(`❌ Error: ${error.message}`);
              core.setFailed(error.message);
            }
