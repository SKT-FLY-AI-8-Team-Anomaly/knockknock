name: Assign Reviewers (All except author)

on:
  pull_request:
    types: [opened, reopened, ready_for_review]

jobs:
  assign-reviewers:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read # 협업자 목록 조회 권한

    steps:
      - name: Assign Reviewers automatically
        uses: actions/github-script@v7
        with:
          script: |
            // 1. PR 작성자 및 리포지토리 정보 가져오기
            const author = context.payload.pull_request.user.login;
            const { owner, repo } = context.repo;
            const prNumber = context.payload.pull_request.number;

            console.log(`PR Author: ${author}`);

            try {
              // 2. 리포지토리의 모든 협업자(Collaborators) 목록 조회
              const collaborators = await github.paginate(
                github.rest.repos.listCollaborators,
                { owner, repo, affiliation: 'all' }
              );

              // 3. 작성자(Author)와 봇(Bot)을 제외한 리뷰어 리스트 생성
              const reviewers = collaborators
                .map(c => c.login)
                .filter(login => login !== author && !login.endsWith('[bot]'));

              console.log(`Found Reviewers: ${reviewers.join(', ')}`);

              // 4. 리뷰어가 1명 이상일 때만 요청 전송
              if (reviewers.length > 0) {
                await github.rest.pulls.requestReviewers({
                  owner,
                  repo,
                  pull_number: prNumber,
                  reviewers: reviewers
                });
                console.log("✅ Review request sent successfully.");
              } else {
                console.log("⚠️ No eligible reviewers found.");
              }
            } catch (error) {
              console.log("❌ Error:", error.message);
              // 권한 문제 등으로 실패해도 워크플로우를 중단하지 않으려면 아래 줄 삭제
              core.setFailed(error.message); 
            }
