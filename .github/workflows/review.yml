name: Assign Reviewers (All except author)

on:
  pull_request:
    types: [opened, reopened, ready_for_review]

jobs:
  assign-reviewers:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
    steps:
      - name: Assign reviewers (exclude author)
        env:
          GH_TOKEN: ${{ secrets.SHL0501TOKEN }}
        run: |
          # 1. PR 기본 정보 설정
          author="${{ github.event.pull_request.user.login }}"
          pr_number="${{ github.event.pull_request.number }}"
          repo="${{ github.repository }}"

          echo "--------------------------------"
          echo "PR Author: $author"
          echo "Repo: $repo"
          echo "--------------------------------"

          # 2. 리뷰어 목록을 JSON 배열로 가져오기 (예: ["user1", "user2"])
          reviewers=$(gh api repos/$repo/collaborators \
            --jq "[.[] | select(.login != \"$author\") | .login]")

          echo "Found Reviewers (JSON): $reviewers"

          # 3. 리뷰어가 없는 경우(빈 배열) 종료
          if [ "$reviewers" == "[]" ] || [ -z "$reviewers" ]; then
            echo "⚠️ No eligible reviewers found."
            exit 0
          fi

          # 4. JSON 파일 생성 (따옴표 문제 해결의 핵심)
          # 데이터를 변수에 담아 직접 전송하지 않고, 파일(payload.json)로 저장합니다.
          echo "{\"reviewers\": $reviewers}" > payload.json

          # 파일 내용 확인 (디버깅용)
          echo "Payload Content:"
          cat payload.json

          # 5. gh api로 파일 전송
          # --input 옵션으로 파일을 직접 읽어 보내므로 파싱 에러가 발생하지 않습니다.
          gh api "repos/$repo/pulls/$pr_number/requested_reviewers" --input payload.json
          
          echo "✅ Review request sent successfully!"
